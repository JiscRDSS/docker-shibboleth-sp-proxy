Archivematica Shibboleth SP Proxy Docker Container
===============================================

Provides a reverse proxy that acts as a Shibboleth SP layer in front of Archivematica. It is based on the [docker-shibboleth-sp-proxy](https://github.com/leanix/docker-shibboleth-sp-proxy) project but has been updated and adapted specifically for Archivematica.

The main difference is there are now two SPs defined, one for the Archivematica Dashboard and one for the Archivematica Storage service. The base image has also been changed, so that it uses the `debian-slim` OS rather than `ubuntu`, to try and keep the image size down as much as possible.

The implementation uses Apache2 with the Shibboleth SP daemon ("`shibd`") and `mod_shib`. Ansible is used both to provision the installed environment, and also for to configure the Apache2 and Shibboleth services within the container. Configuration is done using [Jinja2 templates](http://jinja.pocoo.org/docs/2.10/templates/).

Both SP services are exposed on port 80 and their vhost server names are configured via environment variables.

Building
---------

The build uses `make`. By default the `build` goal is executed, which executes the `build-image` goal. The `clean` goal can be used to remove files.

The build accepts the following build parameters:

| Parameter | Description | Default Value |
|---|---|---|
| `IMAGE_TAG_NAME` | The image name to tag the built Docker image with. | `arkivum/rdss-archivematica-shib-sp-proxy` |
| `IMAGE_TAG_VERSION` | The version to tag the built Docker image with. | `latest` |

For example:

	make IMAGE_TAG_NAME="myorg/custom-shib-sp-proxy" IMAGE_TAG_VERSION="2.1"

Environment Variables
-----------------------

The following environment variables are defined for this docker image:

| Variable | Description |
|---|---|
| `AM_DASHBOARD_HOST` | Host name for the Archivematica Dashboard, e.g. `dashboard.archivematica.example.ac.uk` |
| `AM_DASHBOARD_SSL_CA_BUNDLE_FILE` | The CA certificates file to secure the Archivematica Dashboard with for Shibboleth communications. This is expected to be a bundle, with the whole certificate chain included. |
| `AM_DASHBOARD_SSL_CERT_FILE` | Certificate file to secure the Archivematica Dashboard with for Shibboleth communications. |
| `AM_DASHBOARD_SSL_KEY_FILE` | Private key file to secure the Archivematica Dashboard service with. |
| `AM_DASHBOARD_TARGET_PORT` | Port that authorized requests for the Archivematica Dashboard should be forwarded to. |
| `AM_STORAGE_SERVICE_HOST` | Host name for the Archivematica Storage Service, e.g. `ss.archivematica.example.ac.uk` |
| `AM_STORAGE_SERVICE_SSL_CA_BUNDLE_FILE` |  The CA certificates file to secure the Archivematica Storage Service with for Shibboleth communications. This is expected be a bundle, with the whole certificate chain included. |
| `AM_STORAGE_SERVICE_SSL_CERT_FILE` | The certificate file to secure the Archivematica Storage Service with for Shibboleth communications. |
| `AM_STORAGE_SERVICE_SSL_KEY_FILE` | The private key file to secure the Archivematica Storage Service service with. |
| `AM_STORAGE_SERVICE_TARGET_PORT` | Port that authorized requests for the Archivematica Storage Service should be forwarded to. |
| `SHIBBOLETH_IDP_ENTITY_ID` | The `entityID` of the IdP that the SP should use for authentication. By default it will use the local Shibboleth IdP service. |
| `SHIBBOLETH_METADATA_SIGNING_CERT` | Certificate file to use to verify the signature of metadata responses from the IdP. |
| `SHIBBOLETH_METADATA_URL_SUBST` | The "substitution string" to use when determining the metadata URL for the IdP's entity id. |
| `SHIBBOLETH_SUPPORT_EMAIL` | Email address for Shibboleth support. Shown as a contact point on error pages generated by the Shibboleth SP layer. |
| `TARGET_PROXY_HOST` | Host that authorized requests should be forwarded to. |

All of the above variables are required, there are no default values and no optional parameters.

All certificates and key files for SSL are expected to be in PEM format.


Logging
--------

All log output is sent to `stdout` and `stderr`, so that it can be monitored using `docker logs` or similar.
